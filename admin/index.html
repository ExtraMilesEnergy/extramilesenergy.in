<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Extra Miles Energy - GitHub Upload System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-100">

<div class="max-w-7xl mx-auto p-4">
  
  <!-- Header -->
  <div class="bg-gradient-to-r from-blue-900 to-blue-700 text-white p-6 rounded-2xl shadow-lg mb-6">
    <h1 class="text-3xl font-bold">‚ö° Extra Miles Energy - GitHub Upload System</h1>
    <p class="text-blue-200">Products auto-save to: <strong>ExtraMilesEnergy/extramilesenergy.in</strong></p>
  </div>

  <!-- GitHub Config -->
  <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
    <h2 class="text-xl font-bold mb-4 flex items-center">
      <i class="fab fa-github mr-2"></i>GitHub Configuration
    </h2>
    
    <div class="grid md:grid-cols-3 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium mb-1">GitHub Token *</label>
        <input type="password" id="githubToken" class="w-full border p-3 rounded-xl" placeholder="ghp_xxxxxxxxxxxx">
        <p class="text-xs text-gray-500 mt-1">Required for upload</p>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Repository</label>
        <input type="text" id="githubRepo" class="w-full border p-3 rounded-xl bg-gray-50" value="ExtraMilesEnergy/extramilesenergy.in" readonly>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Branch</label>
        <input type="text" id="githubBranch" class="w-full border p-3 rounded-xl" value="main">
      </div>
    </div>

    <button onclick="testGitHubConnection()" class="bg-blue-600 text-white px-6 py-2 rounded-xl hover:bg-blue-700 mb-4">
      <i class="fas fa-plug mr-2"></i>Test Connection
    </button>

    <div id="connectionStatus" class="hidden p-3 rounded-xl"></div>
  </div>

  <!-- Add Product Form -->
  <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
    <h2 class="text-xl font-bold mb-4">‚ûï Add New Product (Auto Upload to GitHub)</h2>
    
    <div class="grid md:grid-cols-2 gap-6">
      <div>
        <div class="mb-4">
          <label class="block font-medium mb-1">Product Name *</label>
          <input type="text" id="productName" class="w-full border p-3 rounded-xl" placeholder="e.g., Lithium Battery 48V">
        </div>
        
        <div class="mb-4">
          <label class="block font-medium mb-1">Category *</label>
          <select id="productCategory" class="w-full border p-3 rounded-xl">
            <option value="EV Battery">EV Battery</option>
            <option value="Solar ESS Battery">Solar ESS Battery</option>
            <option value="Solar Inverter">Solar Inverter</option>
            <option value="EV Charger">EV Charger</option>
            <option value="Accessories">Accessories</option>
          </select>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block font-medium mb-1">Price (‚Çπ) *</label>
            <input type="number" id="productPrice" class="w-full border p-3 rounded-xl" value="0">
          </div>
          <div>
            <label class="block font-medium mb-1">Stock</label>
            <input type="number" id="productStock" class="w-full border p-3 rounded-xl" value="10">
          </div>
        </div>

        <div class="mb-4">
          <label class="flex items-center">
            <input type="checkbox" id="productFeatured" class="mr-2">
            <span>Mark as Featured</span>
          </label>
        </div>
      </div>

      <div>
        <div class="mb-4">
          <label class="block font-medium mb-1">Images * (Max 5)</label>
          <input type="file" id="productImages" multiple accept="image/*" class="w-full border p-2 rounded-xl">
          <div id="imagePreview" class="grid grid-cols-5 gap-2 mt-3"></div>
        </div>

        <div class="mb-4">
          <label class="block font-medium mb-1">Description *</label>
          <textarea id="productDesc" rows="4" class="w-full border p-3 rounded-xl"></textarea>
        </div>
      </div>
    </div>

    <button onclick="uploadToGitHub()" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-green-700 mt-4">
      <i class="fab fa-github mr-2"></i>SAVE TO GITHUB REPO
    </button>
  </div>

  <!-- Product List -->
  <div class="bg-white rounded-2xl shadow-lg p-6">
    <h2 class="text-xl font-bold mb-4">üì¶ Products in GitHub Repo</h2>
    <div id="productList" class="space-y-3"></div>
  </div>
</div>

<!-- Loader -->
<div id="loader" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded-2xl text-center">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
    <p id="loaderText">Uploading to GitHub...</p>
    <p class="text-sm text-gray-500 mt-2" id="loaderSubtext">Please don't close</p>
  </div>
</div>

<script>
// ==================== CONFIG ====================
let products = [];

// ==================== LOADER ====================
function showLoader(text, subtext) {
  document.getElementById('loaderText').textContent = text || 'Uploading...';
  document.getElementById('loaderSubtext').textContent = subtext || 'Please wait';
  document.getElementById('loader').classList.remove('hidden');
  document.getElementById('loader').classList.add('flex');
}

function hideLoader() {
  document.getElementById('loader').classList.add('hidden');
  document.getElementById('loader').classList.remove('flex');
}

// ==================== FILE TO BASE64 ====================
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => {
      let base64 = reader.result.split(',')[1];
      resolve(base64);
    };
    reader.onerror = error => reject(error);
  });
}

// ==================== GITHUB UPLOAD ====================
async function githubUpload(path, content, message) {
  const token = document.getElementById('githubToken').value;
  const repo = document.getElementById('githubRepo').value;
  const branch = document.getElementById('githubBranch').value;

  if (!token) {
    throw new Error('GitHub token required');
  }

  const url = `https://api.github.com/repos/${repo}/contents/${path}`;
  
  // Check if file exists
  let sha = null;
  try {
    const response = await fetch(url, {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    if (response.ok) {
      const data = await response.json();
      sha = data.sha;
    }
  } catch (e) {
    // File doesn't exist
  }

  // Upload file
  const response = await fetch(url, {
    method: 'PUT',
    headers: {
      'Authorization': `token ${token}`,
      'Content-Type': 'application/json',
      'Accept': 'application/vnd.github.v3+json'
    },
    body: JSON.stringify({
      message: message || `Add ${path}`,
      content: content,
      branch: branch,
      sha: sha
    })
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.message || 'Upload failed');
  }

  return await response.json();
}

// ==================== TEST CONNECTION ====================
async function testGitHubConnection() {
  const token = document.getElementById('githubToken').value;
  const repo = document.getElementById('githubRepo').value;
  
  if (!token) {
    Swal.fire('Error', 'Please enter GitHub token', 'error');
    return;
  }

  showLoader('Testing connection...', 'Checking GitHub API');
  
  try {
    const response = await fetch(`https://api.github.com/repos/${repo}`, {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    if (response.ok) {
      const data = await response.json();
      hideLoader();
      
      document.getElementById('connectionStatus').classList.remove('hidden', 'bg-red-50', 'text-red-700');
      document.getElementById('connectionStatus').classList.add('bg-green-50', 'text-green-700');
      document.getElementById('connectionStatus').innerHTML = `
        <i class="fas fa-check-circle mr-2"></i>
        Connected to ${data.full_name} (${data.private ? 'Private' : 'Public'})
      `;
      
      Swal.fire('Success', 'GitHub connection successful!', 'success');
    } else {
      hideLoader();
      throw new Error('Connection failed');
    }
  } catch (error) {
    hideLoader();
    document.getElementById('connectionStatus').classList.remove('hidden', 'bg-green-50', 'text-green-700');
    document.getElementById('connectionStatus').classList.add('bg-red-50', 'text-red-700');
    document.getElementById('connectionStatus').innerHTML = `
      <i class="fas fa-exclamation-circle mr-2"></i>
      Connection failed: ${error.message}
    `;
    Swal.fire('Error', 'Connection failed', 'error');
  }
}

// ==================== UPLOAD TO GITHUB ====================
async function uploadToGitHub() {
  try {
    // Get form data
    const name = document.getElementById('productName').value;
    const category = document.getElementById('productCategory').value;
    const price = document.getElementById('productPrice').value;
    const stock = document.getElementById('productStock').value;
    const featured = document.getElementById('productFeatured').checked;
    const desc = document.getElementById('productDesc').value;
    const imageFiles = document.getElementById('productImages').files;

    // Validate
    if (!name || !category || !price || imageFiles.length === 0 || !desc) {
      Swal.fire('Error', 'Please fill all required fields', 'error');
      return;
    }

    showLoader('Uploading to GitHub...', 'This may take a few seconds');

    // Create slug
    const slug = name.toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/(^-|-$)/g, '');

    const imageUrls = [];

    // 1. Upload images to GitHub
    for (let i = 0; i < imageFiles.length; i++) {
      const file = imageFiles[i];
      const base64 = await fileToBase64(file);
      const ext = file.name.split('.').pop();
      const imagePath = `products/images/${slug}-${i+1}.${ext}`;
      
      await githubUpload(imagePath, base64, `Add image for ${name}`);
      
      // Get raw URL
      const repo = document.getElementById('githubRepo').value;
      imageUrls.push(`https://raw.githubusercontent.com/${repo}/main/${imagePath}`);
    }

    // 2. Create product HTML
    const productHTML = generateProductHTML({
      name, category, price, stock, featured, desc,
      images: imageUrls,
      slug
    });

    // 3. Upload product HTML to GitHub
    const htmlBase64 = btoa(unescape(encodeURIComponent(productHTML)));
    await githubUpload(`products/${slug}.html`, htmlBase64, `Add product: ${name}`);

    // 4. Save to local array
    const product = {
      id: Date.now(),
      name,
      category,
      price,
      stock,
      featured,
      desc,
      slug,
      imageUrls,
      githubUrl: `https://github.com/${document.getElementById('githubRepo').value}/blob/main/products/${slug}.html`,
      liveUrl: `https://${document.getElementById('githubRepo').value.split('/')[0]}.github.io/${document.getElementById('githubRepo').value.split('/')[1]}/products/${slug}.html`
    };

    products.unshift(product);
    renderProducts();

    hideLoader();
    
    // Show success
    Swal.fire({
      icon: 'success',
      title: 'Uploaded to GitHub!',
      html: `
        <p class="mb-2">‚úÖ Product saved to repository</p>
        <p class="text-sm break-all"><strong>GitHub:</strong> ${product.githubUrl}</p>
        <p class="text-sm break-all mt-2"><strong>Live:</strong> ${product.liveUrl}</p>
      `,
      confirmButtonText: 'View on GitHub',
      showCancelButton: true,
      cancelButtonText: 'Add Another'
    }).then((result) => {
      if (result.isConfirmed) {
        window.open(product.githubUrl, '_blank');
      }
    });

  } catch (error) {
    hideLoader();
    Swal.fire('Error', 'Upload failed: ' + error.message, 'error');
    console.error(error);
  }
}

// ==================== GENERATE PRODUCT HTML ====================
function generateProductHTML(product) {
  const images = product.images.map(img => 
    `<img src="${img}" class="w-full rounded-lg mb-4" alt="${product.name}">`
  ).join('');

  return `<!DOCTYPE html>
<html>
<head>
  <title>${product.name} | Extra Miles Energy</title>
  <meta name="description" content="${product.desc.substring(0, 160)}">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
  <div class="max-w-4xl mx-auto p-6">
    <nav class="text-sm mb-6">
      <a href="/" class="text-blue-600">Home</a> > 
      <a href="/products" class="text-blue-600">Products</a> > 
      <span>${product.name}</span>
    </nav>
    
    <div class="bg-white rounded-2xl shadow-lg p-6">
      <div class="grid md:grid-cols-2 gap-8">
        <div>${images}</div>
        <div>
          <h1 class="text-3xl font-bold mb-4">${product.name}</h1>
          <p class="text-gray-600 mb-2">${product.category}</p>
          <p class="text-2xl font-bold text-blue-600 mb-4">‚Çπ${product.price}</p>
          ${product.featured ? '<span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm">‚≠ê Featured</span>' : ''}
          <p class="text-gray-700 mt-4">${product.desc}</p>
          <p class="text-sm text-gray-500 mt-4">Stock: ${product.stock} units</p>
          
          <div class="mt-6 flex gap-4">
            <a href="https://wa.me/917876555055?text=I'm%20interested%20in%20${product.name}" 
               class="bg-green-600 text-white px-6 py-3 rounded-xl flex-1 text-center hover:bg-green-700">
              <i class="fab fa-whatsapp mr-2"></i>WhatsApp
            </a>
            <a href="tel:+919991144903" 
               class="bg-blue-600 text-white px-6 py-3 rounded-xl flex-1 text-center hover:bg-blue-700">
              <i class="fas fa-phone mr-2"></i>Call Now
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>`;
}

// ==================== RENDER PRODUCTS ====================
function renderProducts() {
  const list = document.getElementById('productList');
  
  if (products.length === 0) {
    list.innerHTML = '<div class="text-center py-8 text-gray-500">No products in GitHub yet</div>';
    return;
  }
  
  list.innerHTML = products.map(p => `
    <div class="border rounded-xl p-4 bg-gray-50">
      <div class="flex justify-between items-start">
        <div>
          <h3 class="font-bold">${p.name}</h3>
          <p class="text-sm text-gray-600">${p.category} ‚Ä¢ ‚Çπ${p.price}</p>
        </div>
        <a href="${p.liveUrl}" target="_blank" class="text-blue-600 hover:text-blue-800">
          <i class="fas fa-external-link-alt mr-1"></i>View Live
        </a>
      </div>
      <p class="text-xs text-gray-500 mt-2 break-all">${p.liveUrl}</p>
    </div>
  `).join('');
}

// ==================== IMAGE PREVIEW ====================
document.getElementById('productImages').addEventListener('change', function(e) {
  const preview = document.getElementById('imagePreview');
  preview.innerHTML = '';
  
  for (let file of e.target.files) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const div = document.createElement('div');
      div.className = 'relative';
      div.innerHTML = `<img src="${e.target.result}" class="w-full h-16 object-cover rounded-lg border">`;
      preview.appendChild(div);
    };
    reader.readAsDataURL(file);
  }
});

// ==================== INIT ====================
window.onload = function() {
  // Load products from localStorage
  const saved = localStorage.getItem('github_products');
  if (saved) {
    products = JSON.parse(saved);
    renderProducts();
  }
};
</script>

</body>
</html>
